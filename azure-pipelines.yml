# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master
- dev

stages:
  - stage: Build
    jobs:
      - job:
        pool:
          vmImage: 'ubuntu-latest'
        steps:
        - task: AzureCLI@1
          displayName: "Build and push image"
          inputs:
            azureSubscription: $(AZURE_SUBSCRIPTION)
            scriptLocation: inlineScript
            inlineScript: "pwsh .ci/deploy-service.ps1 -buildOnly -service $(SERVICE_NAME)"

  - stage: Deploy_dev
    dependsOn: [Build]
    jobs:
      - deployment: Deploy_dev
        pool:
          vmImage: 'Ubuntu-latest'
        
        environment: dev
        strategy:
          runOnce:
            deploy:
              steps:
              - task: AzureCLI@1
                displayName: "Build and push image"
                inputs:
                  azureSubscription: $(AZURE_SUBSCRIPTION)
                  scriptLocation: inlineScript
                  inlineScript: "pwsh .ci/deploy-service.ps1 -azureDevOps -service $(SERVICE_NAME) -environmentShort dev"
      - job: Integration_tests
        dependsOn: Deploy_dev
        pool:
          vmImage: Ubuntu-latest
        steps:
          - script: "echo integration tests"
  